import { readFileSync, writeFileSync } from 'node:fs';
import { join } from 'node:path';

import { Contract, ContractFactory, formatEther, parseEther } from 'ethers';

import packageJson from '../package.json';

import { persistAccountsToWatch } from './accounts-to-watch';
import { blastProvider, contractAddresses, oEtherV2, oUsdb, wallet } from './commons';
import { orbitEtherLiquidatorInterface } from './interfaces';
import { logger } from './logger';

const orbitEtherLiquidatorAddress = contractAddresses.orbitEtherLiquidator;

const main = async () => {
  // Print the wallet and the liquidator contract balances.
  logger.info(`Wallet ETH balance (${wallet.address}) `, {
    eth: formatEther(await blastProvider.getBalance(wallet.address)),
    oEth: formatEther(await oEtherV2.balanceOf!(wallet.address)),
    ethInOEth: formatEther(await oEtherV2.balanceOfUnderlying!.staticCall(wallet.address)),
  });
  logger.info('Wallet USDB balance', {
    oUsdb: formatEther(await oUsdb.balanceOf(wallet.address)),
    usdbInOUsdb: formatEther(await oUsdb.balanceOfUnderlying.staticCall(wallet.address)),
  });
  logger.info('OrbitEtherLiquidator ETH balance', {
    eth: formatEther(await blastProvider.getBalance(contractAddresses.orbitEtherLiquidator)),
    oEth: formatEther(await oEtherV2.balanceOf!(contractAddresses.orbitEtherLiquidator)),
    ethInOEth: formatEther(await oEtherV2.balanceOfUnderlying!.staticCall(contractAddresses.orbitEtherLiquidator)),
  });
  logger.info('OrbitEtherLiquidator USDB balance', {
    oUsdb: formatEther(await oUsdb.balanceOf(contractAddresses.orbitEtherLiquidator)),
    usdbInOUsdb: formatEther(await oUsdb.balanceOfUnderlying.staticCall(contractAddresses.orbitEtherLiquidator)),
  });

  const orbitEtherLiquidator = new Contract(
    orbitEtherLiquidatorAddress,
    orbitEtherLiquidatorInterface,
    wallet.connect(blastProvider)
  );

  // Expected usage is to call this script with the type of command to perform.
  // eslint-disable-next-line @typescript-eslint/prefer-destructuring
  const command = process.argv[2];
  switch (command) {
    case 'deploy': {
      logger.info('Deploying new OrbitEtherLiquidator contract');

      const deployTx = await new ContractFactory(
        orbitEtherLiquidatorInterface,
        orbitEtherLiquidatorBytecode,
        wallet.connect(blastProvider)
      ).deploy(contractAddresses.orbitSpaceStation);

      await deployTx.deploymentTransaction()?.wait(1);
      const address = await deployTx.getAddress();
      logger.info('Deployed OrbitEtherLiquidator', {
        txHash: deployTx.deploymentTransaction()!.hash,
        address,
      });
      process.stdout.write([`Add the following to your .env:`, `ETHER_LIQUIDATOR_ADDRESS=${address} `, ``].join('\n'));

      return;
    }
    case 'deposit': {
      const ethToSend = process.argv[3]!;
      if (!ethToSend) throw new Error('ETH amount to deposit is required (e.g. 0.05)');
      logger.info('Depositing ETH to OrbitEtherLiquidator contract', {
        address: await orbitEtherLiquidator.getAddress(),
        ethToSend: parseEther(ethToSend),
      });

      const depositTx = await orbitEtherLiquidator.deposit!({ value: parseEther(ethToSend) });
      await depositTx.wait(1);
      logger.info('Deposited', { txHash: depositTx.hash });
      return;
    }
    case 'withdraw-all-eth': {
      logger.info('Withdrawing all ETH from OrbitEtherLiquidator contract', {
        address: await orbitEtherLiquidator.getAddress(),
      });

      const withdrawalTx = await orbitEtherLiquidator.withdrawAllEth!();
      await withdrawalTx.wait(1);
      logger.info('Withdrew', { txHash: withdrawalTx.hash });
      return;
    }
    case 'withdraw-all-token': {
      const tokenAddress = process.argv[3]!;
      if (!tokenAddress) throw new Error('Token address to withdraw is required');
      logger.info('Withdrawing all tokens from OrbitEtherLiquidator contract', {
        address: await orbitEtherLiquidator.getAddress(),
      });

      const withdrawalTx = await orbitEtherLiquidator.withdrawAllToken!(tokenAddress);
      await withdrawalTx.wait(1);
      logger.info('Withdrew', { txHash: withdrawalTx.hash });
      return;
    }
    case 'prepare-accounts-to-watch': {
      await persistAccountsToWatch();
      return;
    }
    case 'prepare-deployment': {
      logger.info('Preparing deployment');

      const template = readFileSync(join(__dirname, 'deployments/orbit-bots.template.json'), 'utf8');
      const deployment = template.replaceAll('<VERSION>', packageJson.version);
      writeFileSync(join(__dirname, 'deployments/orbit-bots.json'), deployment);
      return;
    }
    default: {
      logger.error('Unknown action', { command });
      return;
    }
  }
};

export const orbitEtherLiquidatorBytecode =
  '0x608060405234801561001057600080fd5b506040516112f33803806112f383398101604081905261002f916100d4565b338061005557604051631e4fbdf760e01b81526000600482015260240160405180910390fd5b61005e81610084565b50600180546001600160a01b0319166001600160a01b0392909216919091179055610104565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6000602082840312156100e657600080fd5b81516001600160a01b03811681146100fd57600080fd5b9392505050565b6111e0806101136000396000f3fe60806040526004361061009c5760003560e01c8063aab3f86811610064578063aab3f86814610157578063ae4dd0fc1461018c578063bf07fa0e146101ac578063c311d049146101cc578063d0e30db0146101ec578063f2fde38b146101f457600080fd5b8063519af30e146100a157806367da0163146100b8578063715018a6146100f05780638da5cb5b146101055780639e281a9814610137575b600080fd5b3480156100ad57600080fd5b506100b6610214565b005b3480156100c457600080fd5b506100d86100d3366004610e0e565b6102a3565b6040516100e793929190610e83565b60405180910390f35b3480156100fc57600080fd5b506100b6610738565b34801561011157600080fd5b506000546001600160a01b03165b6040516001600160a01b0390911681526020016100e7565b34801561014357600080fd5b506100b6610152366004610ef9565b61074c565b34801561016357600080fd5b50610177610172366004610f25565b6107eb565b604080519283526020830191909152016100e7565b34801561019857600080fd5b506100b66101a7366004610f76565b610ba5565b3480156101b857600080fd5b5060015461011f906001600160a01b031681565b3480156101d857600080fd5b506100b66101e7366004610f9a565b610ca5565b6100b6610cf4565b34801561020057600080fd5b506100b661020f366004610f76565b610d3e565b61021c610d7c565b47806102665760405162461bcd60e51b81526020600482015260146024820152734e6f20657468657220746f20776974686472617760601b60448201526064015b60405180910390fd5b600080546040516001600160a01b039091169183156108fc02918491818181858888f1935050505015801561029f573d6000803e3d6000fd5b5050565b600154604051632aff3bff60e21b81526001600160a01b038481166004830152606092839283929091169063abfceffc90602401600060405180830381865afa1580156102f4573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f1916820160405261031c9190810190610fd9565b9250825167ffffffffffffffff81111561033857610338610fb3565b604051908082528060200260200182016040528015610361578160200160208202803683370190505b509150825167ffffffffffffffff81111561037e5761037e610fb3565b6040519080825280602002602001820160405280156103a7578160200160208202803683370190505b5090506000600160009054906101000a90046001600160a01b03166001600160a01b0316637dc0d1d06040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103ff573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610423919061109e565b60405163fc57d4df60e01b81526001600160a01b038781166004830152919091169063fc57d4df90602401602060405180830381865afa15801561046b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061048f91906110bb565b905060005b845181101561072f576000806000808885815181106104b5576104b56110d4565b60209081029190910101516040516361bfb47160e11b81526001600160a01b038d811660048301529091169063c37f68e290602401608060405180830381865afa158015610507573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061052b91906110ea565b9350935093509350836000146105835760405162461bcd60e51b815260206004820152601860248201527f6765744163636f756e74536e617073686f74206572726f720000000000000000604482015260640161025d565b81888681518110610596576105966110d4565b6020026020010181815250506000600160009054906101000a90046001600160a01b03166001600160a01b0316637dc0d1d06040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105f7573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061061b919061109e565b6001600160a01b031663fc57d4df8b888151811061063b5761063b6110d4565b60200260200101516040518263ffffffff1660e01b815260040161066e91906001600160a01b0391909116815260200190565b602060405180830381865afa15801561068b573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106af91906110bb565b905086670de0b6b3a764000082816106c78689611136565b6106d19190611153565b6106db9190611136565b6106e59190611153565b6106f790670de0b6b3a7640000611136565b6107019190611153565b888781518110610713576107136110d4565b6020908102919091010152505060019093019250610494915050565b50509250925092565b610740610d7c565b61074a6000610da9565b565b610754610d7c565b816001600160a01b031663a9059cbb6107756000546001600160a01b031690565b6040516001600160e01b031960e084901b1681526001600160a01b039091166004820152602481018490526044016020604051808303816000875af11580156107c2573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107e69190611175565b505050565b600080824710156108355760405162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b604482015260640161025d565b604051633af9e66960e01b81523060048201526000906001600160a01b03861690633af9e669906024016020604051808303816000875af115801561087e573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108a291906110bb565b604051635572051560e11b81526001600160a01b03888116600483015287811660248301529192509088169063aae40a2a9086906044016000604051808303818588803b1580156108f257600080fd5b505af1158015610906573d6000803e3d6000fd5b5050604051633af9e66960e01b8152306004820152600093506001600160a01b0389169250633af9e66991506024016020604051808303816000875af1158015610954573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061097891906110bb565b90506000600160009054906101000a90046001600160a01b03166001600160a01b0316637dc0d1d06040518163ffffffff1660e01b8152600401602060405180830381865afa1580156109cf573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109f3919061109e565b60405163fc57d4df60e01b81526001600160a01b038b81166004830152919091169063fc57d4df90602401602060405180830381865afa158015610a3b573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a5f91906110bb565b90506000600160009054906101000a90046001600160a01b03166001600160a01b0316637dc0d1d06040518163ffffffff1660e01b8152600401602060405180830381865afa158015610ab6573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610ada919061109e565b60405163fc57d4df60e01b81526001600160a01b038a81166004830152919091169063fc57d4df90602401602060405180830381865afa158015610b22573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b4691906110bb565b905060008282610b568787611197565b610b609190611136565b610b6a9190611153565b9050610b768882611197565b9650670de0b6b3a7640000610b8b8489611136565b610b959190611153565b9550505050505094509492505050565b610bad610d7c565b806001600160a01b031663a9059cbb610bce6000546001600160a01b031690565b6040516370a0823160e01b81523060048201526001600160a01b038516906370a0823190602401602060405180830381865afa158015610c12573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610c3691906110bb565b6040516001600160e01b031960e085901b1681526001600160a01b03909216600483015260248201526044016020604051808303816000875af1158015610c81573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061029f9190611175565b610cad610d7c565b804710156102665760405162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b604482015260640161025d565b610cfc610d7c565b6000341161074a5760405162461bcd60e51b815260206004820152600f60248201526e26bab9ba1039b2b7321032ba3432b960891b604482015260640161025d565b610d46610d7c565b6001600160a01b038116610d7057604051631e4fbdf760e01b81526000600482015260240161025d565b610d7981610da9565b50565b6000546001600160a01b0316331461074a5760405163118cdaa760e01b815233600482015260240161025d565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6001600160a01b0381168114610d7957600080fd5b60008060408385031215610e2157600080fd5b8235610e2c81610df9565b91506020830135610e3c81610df9565b809150509250929050565b60008151808452602080850194506020840160005b83811015610e7857815187529582019590820190600101610e5c565b509495945050505050565b606080825284519082018190526000906020906080840190828801845b82811015610ec55781516001600160a01b031684529284019290840190600101610ea0565b5050508381036020850152610eda8187610e47565b9150508281036040840152610eef8185610e47565b9695505050505050565b60008060408385031215610f0c57600080fd5b8235610f1781610df9565b946020939093013593505050565b60008060008060808587031215610f3b57600080fd5b8435610f4681610df9565b93506020850135610f5681610df9565b92506040850135610f6681610df9565b9396929550929360600135925050565b600060208284031215610f8857600080fd5b8135610f9381610df9565b9392505050565b600060208284031215610fac57600080fd5b5035919050565b634e487b7160e01b600052604160045260246000fd5b8051610fd481610df9565b919050565b60006020808385031215610fec57600080fd5b825167ffffffffffffffff8082111561100457600080fd5b818501915085601f83011261101857600080fd5b81518181111561102a5761102a610fb3565b8060051b604051601f19603f8301168101818110858211171561104f5761104f610fb3565b60405291825284820192508381018501918883111561106d57600080fd5b938501935b828510156110925761108385610fc9565b84529385019392850192611072565b98975050505050505050565b6000602082840312156110b057600080fd5b8151610f9381610df9565b6000602082840312156110cd57600080fd5b5051919050565b634e487b7160e01b600052603260045260246000fd5b6000806000806080858703121561110057600080fd5b505082516020840151604085015160609095015191969095509092509050565b634e487b7160e01b600052601160045260246000fd5b808202811582820484141761114d5761114d611120565b92915050565b60008261117057634e487b7160e01b600052601260045260246000fd5b500490565b60006020828403121561118757600080fd5b81518015158114610f9357600080fd5b8181038181111561114d5761114d61112056fea26469706673582212200c496e7cab95ae6f240dbf10c446665ed6f27c11d9677a6a55ab8f653bb56e5564736f6c63430008180033';

void main().catch((error) => {
  logger.error('Unexpected error', error);
  process.exit(1);
});
